---
create: '2025-06-01'
modified: '2025-06-01'
---

# 10亿红包雨实现

## 前置问题

1. 每个用户能抢到多少红包？
    1. 红包的总金额限制
    2. 红包的总数量限制
    3. 每个红包本身的金额限制
2. 整个过程持续多久？
    1. 十几秒，峰值比较高
    2. 几天，相对来说QPS就比较低
3. 数量级评估
    1. 10亿，假设每个用户最多能抢10块钱，QPS数量级在千万级别
    2. 红包雨的效果可以一定程度上分散请求，QPS在百万级别
        1. 假设一台机器的能承载10w，那么几十台机器就足够了
        2. 保险起见，用100台机器的集群去扛住压力
4. 设计的核心重点在哪里
    1. 高性能：保证用户体验，用户能尽快看到结果，同时金额能入账户
    2. 高可靠：不能超发，保证企业的利益，不能给企业带来损失
    3. 高可用：活动期间服务不能挂，或者挂了也能迅速转移流量顶上
5. 实现的难度控制
    1. 不用考虑正好10亿全部送出，这样整个系统实现的成本会非常高，只需要保证不超发就行

## 设计

### 预分配金额

如果抢到红包的时候，在数据库中去扣除总金额，那么数据库是扛不住压力的，连接池的连接也不够用。

所以红包应该分片存在缓存里。如果使用redis，那么也不行，因为redis单节点只支持10wQPS，很有可能超时。所以可以考虑将金额预先分配到100个机器里，每个机器里100w金额，通过本地内存去扣除，性能是最高的。

### 持久化怎么做

在抢到红包之后，每个用户希望知道自己分了多少钱，这个数据需要持久化到数据库中，但是数据库不能让每个用户都去写，否则连接肯定是不够的。

可以将抢到的红包数据，放入到队列里，批量写入到数据库中。

可以考虑，开启事务去写流水，但是先不提交事务，而是先扣减内存中的库存，再去提交事务。这样可以保证金额扣减在内存里和数据库里，是一个原子操作。

对于红包金额，不能用批量的方式去扣减，而是应该通过新增的方式去插入，这样就不会对红包的金额产生很高的行锁的竞争。

### 机器挂了怎么办

从产品角度去考虑，机器挂了的结果也就是这个机器上的钱没发出去，这个并不会造成损失。需要考虑的是负载均衡上，如果机器挂的太多会导致整个集群的雪崩，因此需要在压测的时候，如果需要100台机器，那么应该增加到120台，来保证整个集群的可用。

### 某个机器上的钱先发完了怎么办

这个主要是负载均衡算法的问题，导致没能均衡地把钱发完。另外从产品的角度考虑，发完了就可以认为用户运气不好，没抢到就行了。

### 整体架构

从整个架构上来看，后端的设计非常简单，只有应用机器的集群和数据库，并没有引入缓存和消息中间件。每增加一层中间件，整个系统就会更加脆弱。

### 其它设计

前端，按钮置灰，减少二次请求。

后端，接口做防止二次请求的操作。