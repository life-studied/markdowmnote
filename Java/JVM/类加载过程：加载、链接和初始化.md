---
create: '2025-05-04'
modified: '2025-05-04'
---

# 类加载过程：加载、链接和初始化

## 1. **加载（Loading）**

加载是类加载过程的第一阶段，主要完成以下任务：

### （1）**通过类的全限定名获取类的二进制字节流**

- JVM通过类的全限定名（如`java.lang.String`）来定位类的字节码文件（`.class`文件）。这个过程可以通过多种方式实现：
    - **文件系统**：从本地磁盘的指定目录（如`classpath`指定的路径）加载`.class`文件。
    - **网络**：通过网络从远程服务器加载类的字节码。
    - **数据库**：从数据库中读取类的字节码。
    - **自定义方式**：通过自定义类加载器（继承`java.lang.ClassLoader`）实现其他加载方式，例如从内存中的字节数组加载类。

### （2）**将这些字节流转换成一个`java.lang.Class`对象**

- JVM将获取到的字节码数据转换为一个`Class`对象，这个对象是类在JVM中的运行时表示。`Class`对象存储了类的结构信息，包括类名、字段、方法、接口等元数据。

### （3）**将`Class`对象存储到方法区**

- 方法区是JVM内存区域之一，用于存储类的结构信息和常量池等数据。加载完成后，`Class`对象被存储到方法区中，供后续的链接和初始化阶段使用。

## 2. **链接（Linking）**

链接阶段是类加载过程的第二个阶段，它进一步完善类的结构，主要分为三个步骤：验证、准备和解析。

### （1）**验证（Verification）**

验证是链接阶段的第一步，目的是确保加载的类信息符合JVM规范，保证类的正确性和安全性。验证主要包括以下内容：

- **文件格式验证**：检查字节码文件的格式是否符合规范，例如是否以`0xCAFEBABE`开头（这是`.class`文件的魔数）。
- **元数据验证**：检查类的元数据是否符合语义规范，例如是否有非法的字段或方法定义。
- **字节码验证**：验证字节码指令序列是否合法，例如是否有非法的跳转指令。
- **符号引用验证**：检查类中的符号引用是否正确，例如是否引用了不存在的类或方法。

验证阶段是JVM保证类安全的重要环节，如果验证失败，JVM会抛出`VerifyError`异常。

### （2）**准备（Preparation）**

准备阶段是为类的静态变量分配内存，并设置默认初始值。这个阶段主要完成以下任务：

- **分配内存**：为类的静态变量分配内存空间。这些内存分配在Java堆中。
- **设置默认初始值**：为静态变量设置默认值。例如，`int`类型的静态变量默认值为`0`，`boolean`类型的静态变量默认值为`false`，引用类型的静态变量默认值为`null`。

需要注意的是，准备阶段只是为静态变量分配内存并设置默认值，不会执行类的初始化代码（如静态代码块）。

### （3）**解析（Resolution）**

解析阶段是将类、接口、字段和方法的符号引用转换为直接引用。符号引用是以文本形式存在的，例如类名、方法名等；直接引用是直接指向目标的内存地址或句柄。

解析主要包括以下内容：

- **类或接口的解析**：将类或接口的符号引用转换为对应的`Class`对象。
- **字段解析**：将字段的符号引用转换为直接引用，例如确定字段在内存中的偏移量。
- **方法解析**：将方法的符号引用转换为直接引用，例如确定方法的内存地址。

解析阶段完成后，类的结构信息已经完整，可以被JVM直接使用。

## 3. **初始化（Initialization）**

初始化阶段是类加载过程的最后一个阶段，也是类加载过程中执行类的初始化代码的阶段。主要完成以下任务：

### （1）**执行类构造器`<clinit>`方法**

- 类构造器`<clinit>`方法是由编译器自动收集类中的所有静态变量赋值操作和静态代码块中的语句组成的。它是一个特殊的静态方法，用于初始化类的静态变量。

例如，以下代码：

```java
class Example {
    static int a = 1;
    static {
        a = 2;
    }
}
```

编译后，`<clinit>`方法的内容为：

```java
static {
    a = 1;
    a = 2;
}
```

在初始化阶段，JVM会执行`<clinit>`方法，完成静态变量的初始化。

#### （2）**执行父类的初始化**

- 如果类有父类，JVM会先初始化父类，再初始化当前类。父类的初始化过程也是按照加载、链接和初始化的顺序进行的。

#### （3）**初始化类的静态变量**

- 在`<clinit>`方法中，静态变量会被赋予指定的值。例如，`static int a = 1;`会在初始化阶段将`a`的值设置为`1`。

初始化阶段是类加载过程中最复杂的阶段，因为它涉及到代码的执行。如果在初始化阶段出现异常，JVM会抛出`ExceptionInInitializerError`异常。

### 总结

Java类加载过程是一个复杂的过程，分为加载、链接和初始化三个阶段。加载阶段主要完成类的字节码加载和`Class`对象的创建；链接阶段通过验证、准备和解析进一步完善类的结构；初始化阶段则通过执行类构造器`<clinit>`方法完成静态变量的初始化。这个过程保证了类的正确加载和运行，是Java程序运行的基础机制。