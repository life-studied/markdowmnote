---
create: '2025-12-21'
modified: '2025-12-21'
---

# Sandboxie 架构解读

基于对源代码的分析，Sandboxie 是一个 Windows 应用程序沙箱解决方案，其架构分为内核模式和用户模式组件，协同工作以隔离应用程序。

## 1. 核心组件

### 1.1 内核驱动 (SboxDrv)

- __位置__: `Sandboxie/core/drv/`

- __职责__: 提供系统级拦截和隔离机制。

  - 文件系统虚拟化：重定向文件操作到沙箱目录。
  - 注册表虚拟化：重定向注册表操作。
  - 进程和线程管理：监控进程创建、注入。
  - 对象管理器过滤：拦截句柄操作。
  - 系统调用钩子：拦截关键系统调用（NtCreateFile、NtOpenKey等）。
  - IPC（进程间通信）隔离：限制沙箱内外进程通信。

- __关键文件__:

  - `driver.c/h`：驱动入口和全局管理。
  - `process.c/h`：进程管理。
  - `file.c/h`：文件系统虚拟化。
  - `key.c/h`：注册表虚拟化。
  - `hook.c/h`：系统调用钩子。
  - `ipc.c/h`：IPC隔离。

### 1.2 用户模式服务 (SboxSvc)

- __位置__: `Sandboxie/core/svc/`

- __职责__: 作为驱动与用户模式组件之间的桥梁。

  - 管理命名管道服务器，处理来自沙箱进程的请求。
  - 协调多个子服务器（ProcessServer、FileServer、ComServer等）。
  - 提供配置管理、进程监控、文件恢复等功能。
  - 与驱动通过设备I/O控制代码（IOCTL）通信。

- __关键文件__:

  - `main.cpp`：服务入口点。
  - `PipeServer.cpp/h`：管道服务器基类。
  - 各种`*Server.cpp`：处理特定领域的请求（如`ProcessServer`处理进程相关请求）。

### 1.3 注入DLL (SboxDll)

- __位置__: `Sandboxie/core/dll/`

- __职责__: 注入到每个沙箱进程中，拦截用户模式API调用。

  - 挂钩Windows API（通过IAT钩子或内联钩子）。
  - 与驱动和服务协作，实施策略。
  - 处理文件路径转换、注册表重定向、IPC限制等。
  - 提供每个线程的本地存储（TLS）来管理状态。

- __关键文件__:

  - `dllmain.c`：DLL入口点。
  - `dllhook.c`：钩子安装。
  - `file.c`：文件相关拦截。
  - `key.c`：注册表相关拦截。
  - `sbiedll.h`：公共API定义。

### 1.4 低级DLL (LowLevel)

- __位置__: `Sandboxie/core/low/`

- __职责__: 辅助代码注入，用于早期进程初始化的钩子。

  - 嵌入到SboxSvc中作为资源。
  - 在进程创建早期注入，确保沙箱策略在进程完全启动前生效。

## 2. 用户界面与控制组件

### 2.1 经典界面 (Sandboxie Classic)

- __位置__: `Sandboxie/apps/`

  - `control/`：SbieCtrl.exe – 实时监控沙箱活动。
  - `start/`：start.exe – 启动沙箱进程。
  - `ini/`：SbieIni.exe – 配置管理工具。
  - `com/`：各种COM代理（BITS、Crypto、RpcSs等）。

- __特点__: 基于MFC的轻量级界面，功能直接。

### 2.2 现代界面 (Sandboxie Plus)

- __位置__: `SandboxiePlus/`

  - `SandMan/`：主GUI应用程序，基于Qt。
  - `QSbieAPI/`：C++ Qt封装层，提供高级API。
  - `SbieShell/`：Shell扩展（右键菜单集成）。

- __特点__: 功能丰富，包括高级监控、配置管理、文件恢复、网络隔离等。

### 2.3 工具集 (SandboxieTools)

- __位置__: `SandboxieTools/`

  - `ImBox/`：镜像盒管理（加密容器）。
  - `ImDisk/`：虚拟磁盘驱动集成。
  - `UpdUtil/`：更新工具。

- __用途__: 扩展功能，如创建加密沙箱存储。

## 3. 通信架构

### 3.1 内核-用户通信

- __IOCTL__: 服务通过`DeviceIoControl`与驱动通信，发送命令和接收状态。
- __驱动接口__: 驱动暴露设备对象（`\Device\Sandboxie`），服务打开句柄与之通信。

### 3.2 进程间通信 (IPC)

- __命名管道__: 服务启动多个命名管道服务器（`Sandboxie_*`），沙箱进程通过管道请求操作（如文件访问、进程创建）。
- __LPC/RPC__: 用于COM和RPC隔离，重定向到沙箱内代理进程。

### 3.3 配置管理

- __配置文件__: `sandboxie.ini`（或`Sandboxie.ini`）存储全局和每个沙箱的配置。
- __动态配置__: 驱动和服务通过IOCTL读取配置，支持运行时更新。

## 4. 虚拟化策略

### 4.1 文件系统虚拟化

- __重定向规则__: 根据配置（`FilePath`、`OpenFilePath`等），将文件操作重定向到沙箱目录（`%SANDBOX%`）。
- __复制策略__: 首次写入时复制（copy-on-write），原始文件保持不变。
- __恢复机制__: 用户可以从沙箱中恢复文件到原始位置。

### 4.2 注册表虚拟化

- __重定向__: 将`HKEY_CURRENT_USER`和`HKEY_LOCAL_MACHINE`的部分键重定向到沙箱内的注册表文件。
- __合并视图__: 沙箱进程看到合并的视图（原始值+沙箱修改）。

### 4.3 进程与对象隔离

- __进程限制__: 沙箱进程不能直接访问外部进程，除非明确允许。
- __对象命名空间__: 使用私有命名空间（如事件、互斥体）防止冲突。
- __令牌限制__: 降低进程令牌权限，防止特权提升。

### 4.4 网络隔离

- __防火墙集成__: 通过Windows过滤平台（WFP）驱动层过滤网络流量。
- __代理设置__: 可强制沙箱进程使用代理服务器。

## 5. 扩展性与插件

### 5.1 钩子框架

- __驱动钩子__: 通过系统调用表（SSDT）或过滤管理器（Minifilter）实现。
- __用户钩子__: 通过导入地址表（IAT）钩子、内联钩子或Detours库实现。

### 5.2 第三方集成

- __防病毒兼容__: 通过排除列表避免冲突。
- __虚拟化技术__: 与ImDisk虚拟磁盘驱动集成，支持加密容器。

## 6. 构建系统

### 6.1 解决方案文件

- `Sandbox.sln`：经典驱动、服务、DLL的完整解决方案。
- `SandboxDll.sln`：仅DLL相关项目。
- `SandboxDrv.sln`：仅驱动相关项目。
- `SandboxiePlus.sln`：Plus GUI解决方案。

### 6.2 依赖项

- __Windows Driver Kit (WDK)__：用于构建内核驱动。
- __Visual Studio 2019__：主要开发环境。
- __Qt 5/6__：用于Plus界面。
- __MFC__：用于经典界面。

## 7. 二次开发建议

### 7.1 添加新功能

- __驱动层__: 在`core/drv/`中添加新的过滤逻辑（如新的对象类型）。
- __服务层__: 在`core/svc/`中添加新的服务器处理特定请求。
- __DLL层__: 在`core/dll/`中添加新的API钩子。

### 7.2 修改现有行为

- __配置选项__: 在`common/defines.h`和`common/ini.h`中添加新配置常量。
- __钩子点__: 在`core/dll/hook.c`和`core/drv/hook.c`中定位钩子位置。

### 7.3 调试与测试

- __日志系统__: 驱动和服务都有详细日志（`log.c/h`），可通过`DebugView`查看。
- __测试工具__: 使用`start.exe`启动沙箱进程，观察行为。

## 8. 安全考虑

- __权限降低__: 沙箱进程以低完整性级别（Low Integrity）运行。
- __攻击面减少__: 限制进程能力，减少潜在漏洞影响。
- __代码签名__: 驱动需要数字签名才能在64位Windows上加载。

## 总结

Sandboxie采用分层架构，内核驱动提供底层隔离，用户模式服务协调管理，注入DLL实施用户层策略。经典界面提供基本控制，Plus界面提供现代体验。该设计允许灵活扩展和定制，适合进行二次开发以增强功能或适应特定需求。

作为C++开发者，您可以专注于修改或扩展特定模块，而无需深入逆向工程细节。建议从理解配置系统和钩子机制开始，然后逐步深入驱动或DLL层。