# 设备驱动

## 早期

在早期开发中，应用程序开发者需要直接跟硬件打交道。对于不同硬件需要编写不同的代码去调用。

## 成熟的操作系统

当成熟的操作系统出现后：

Linux：

* 硬件就是文件对象

Windows：

* 图形硬件被抽象为GDI
* 声音和多媒体设备被抽象为DirectX对象
* 磁盘被抽象为普通文件系统

---

繁琐的硬件细节交给了操作系统中的硬件驱动程序来完成。驱动可以看成操作系统的一部分，与操作系统内核共同运行在特权级，同时与操作系统又有一定的独立性。

## 读写磁盘

### 磁盘

磁盘有多个扇片，每个扇片分两面，每面按照同心圆划分若干个磁道，每个磁道划分为若干个扇区。

由于同心圆的周长不一致，如果每个磁道扇区数量一致，则有的外围磁道密度比内圈更加稀疏。因此不同磁道的扇区数不一样，并且使用LBA的方式，用逻辑扇区号来读写以屏蔽细节。

### 读写

向硬件发送IO命令的方式最常见的是通过读写IO端口地址来实现。CPU提供两个指令`in`和`out`来实现。

下面是对1000号（0x000003E8）逻辑扇区开始的8个扇区进行读取的操作，执行的指令类似于：

```
out 0x1F3 0x00	# 要读取LBA地址第1个byte
out 0x1F4 0x00	# 要读取LBA地址第2个byte
out 0x1F5 0x03	# 要读取LBA地址第3个byte
out 0x1F6 0xE8	# 要读取LBA地址第4个byte

out 0x1F2 0x08	# 读取的扇区数
out 0x1F7 0x20	# 命令0x20代表读取
```

