---
create: '2025-05-10'
modified: '2025-05-10'
---

# ffmpeg-makefile编译解读

## 1. configure和config.mak

ffmpeg通过configure脚本配置编译选项，其本质是一个shell脚本，用于生成config.mak文件，在ffbuild目录下。

```makefile
# Automatically generated by configure - do not modify!
ifndef FFMPEG_CONFIG_MAK
FFMPEG_CONFIG_MAK=1
FFMPEG_CONFIGURATION=--prefix=/usr --enable-shared --disable-static --disable-stripping --enable-gpl --enable-version3 --enable-libx264 --enable-libx265
prefix=/usr
LIBDIR=$(DESTDIR)${prefix}/lib
SHLIBDIR=$(DESTDIR)${prefix}/lib
INCDIR=$(DESTDIR)${prefix}/include
BINDIR=$(DESTDIR)${prefix}/bin
DATADIR=$(DESTDIR)${prefix}/share/ffmpeg
DOCDIR=$(DESTDIR)${prefix}/share/doc/ffmpeg
MANDIR=$(DESTDIR)${prefix}/share/man
PKGCONFIGDIR=$(DESTDIR)${prefix}/lib/pkgconfig
INSTALL_NAME_DIR=
SRC_PATH=.
SRC_LINK=.
ifndef MAIN_MAKEFILE
SRC_PATH:=$(SRC_PATH:.%=..%)
endif
CC_IDENT=gcc 11 (Ubuntu 11.4.0-1ubuntu1~22.04)
ARCH=x86
INTRINSICS=sse2
EXTERN_PREFIX=
CC=gcc
CXX=g++
...
!ARCH_AARCH64=yes
!ARCH_ARM=yes
!ARCH_IA64=yes
!ARCH_LOONGARCH=yes
!ARCH_LOONGARCH32=yes
!ARCH_LOONGARCH64=yes
!ARCH_M68K=yes
!ARCH_MIPS=yes
...
CONFIG_DOC=yes
!CONFIG_HTMLPAGES=yes
CONFIG_MANPAGES=yes
CONFIG_PODPAGES=yes
!CONFIG_TXTPAGES=yes
CONFIG_AVIO_HTTP_SERVE_FILES_EXAMPLE=yes
CONFIG_AVIO_LIST_DIR_EXAMPLE=yes
CONFIG_AVIO_READ_CALLBACK_EXAMPLE=yes
CONFIG_DECODE_AUDIO_EXAMPLE=yes
CONFIG_DECODE_FILTER_AUDIO_EXAMPLE=yes
CONFIG_DECODE_FILTER_VIDEO_EXAMPLE=yes
CONFIG_DECODE_VIDEO_EXAMPLE=yes
CONFIG_DEMUX_DECODE_EXAMPLE=yes
CONFIG_ENCODE_AUDIO_EXAMPLE=yes
CONFIG_ENCODE_VIDEO_EXAMPLE=yes
CONFIG_EXTRACT_MVS_EXAMPLE=yes
CONFIG_FILTER_AUDIO_EXAMPLE=yes
CONFIG_HW_DECODE_EXAMPLE=yes
CONFIG_MUX_EXAMPLE=yes
...
```

可以看到，其中既包含了各种路径变量，又包含了编译器等工具变量，以及各种编译选项的配置（`CONFIG_XXX=yes`）。

## 2. 各级目录的Makefile

在各个LIB目录下（例如libavcodec），都有一个Makefile，用于配置.c编译成.o，以及根据config.mak中的配置，是否将.o文件添加进最终的编译里（`OBJS-yes`变量）：

```makefile
NAME = avcodec
DESC = FFmpeg codec library

HEADERS = ac3_parser.h                                                  \
          adts_parser.h                                                 \
          avcodec.h                                                     \
          ...

OBJS = ac3_parser.o                                                     \
       adts_parser.o                                                    \
       allcodecs.o                                                      \
       ...
       
# subsystems
OBJS-$(CONFIG_AANDCTTABLES)            += aandcttab.o
OBJS-$(CONFIG_AC3DSP)                  += ac3dsp.o ac3.o ac3tab.o
OBJS-$(CONFIG_ADTS_HEADER)             += adts_header.o mpeg4audio.o
...
```

## 3. common.mak

在ffbuild/common.mak中，将各个Makefile中收集到的.o文件变量集合到一起：

```makefile
...
OBJS      += $(OBJS-yes)
SLIBOBJS  += $(SLIBOBJS-yes)
FFLIBS    := $($(NAME)_FFLIBS) $(FFLIBS-yes) $(FFLIBS)
TESTPROGS += $(TESTPROGS-yes)
...
```

## 4. 根目录Makefile

最终在根目录的Makefile中，将所有的内容整合到一起，投入编译：

```makefile
MAIN_MAKEFILE=1
include ffbuild/config.mak

vpath %.c    $(SRC_PATH)
vpath %.cpp  $(SRC_PATH)
vpath %.h    $(SRC_PATH)
vpath %.inc  $(SRC_PATH)
vpath %.m    $(SRC_PATH)
vpath %.S    $(SRC_PATH)
vpath %.asm  $(SRC_PATH)
vpath %.rc   $(SRC_PATH)
vpath %.v    $(SRC_PATH)
vpath %.texi $(SRC_PATH)
vpath %.cu   $(SRC_PATH)
vpath %.ptx  $(SRC_PATH)
vpath %/fate_config.sh.template $(SRC_PATH)

...

# $(FFLIBS-yes) needs to be in linking order
FFLIBS-$(CONFIG_AVDEVICE)   += avdevice
FFLIBS-$(CONFIG_AVFILTER)   += avfilter
FFLIBS-$(CONFIG_AVFORMAT)   += avformat
FFLIBS-$(CONFIG_AVCODEC)    += avcodec
FFLIBS-$(CONFIG_AVRESAMPLE) += avresample
FFLIBS-$(CONFIG_POSTPROC)   += postproc
FFLIBS-$(CONFIG_SWRESAMPLE) += swresample
FFLIBS-$(CONFIG_SWSCALE)    += swscale

FFLIBS := avutil

...

# first so "all" becomes default target
all: all-yes

include $(SRC_PATH)/tools/Makefile
include $(SRC_PATH)/ffbuild/common.mak

...
```

## 5. FFmpeg可执行文件的编译

关于FFmpeg可执行文件的Makefile组织，在fftools/Makefile里：

```makefile
...
OBJS-ffmpeg                        += fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o
OBJS-ffmpeg-$(CONFIG_LIBMFX)       += fftools/ffmpeg_qsv.o
ifndef CONFIG_VIDEOTOOLBOX
OBJS-ffmpeg-$(CONFIG_VDA)          += fftools/ffmpeg_videotoolbox.o
endif
OBJS-ffmpeg-$(CONFIG_VIDEOTOOLBOX) += fftools/ffmpeg_videotoolbox.o

define DOFFTOOL
OBJS-$(1) += fftools/cmdutils.o fftools/$(1).o $(OBJS-$(1)-yes)
$(1)$(PROGSSUF)_g$(EXESUF): $$(OBJS-$(1))
$$(OBJS-$(1)): | fftools
$$(OBJS-$(1)): CFLAGS  += $(CFLAGS-$(1))
$(1)$(PROGSSUF)_g$(EXESUF): LDFLAGS += $(LDFLAGS-$(1))
$(1)$(PROGSSUF)_g$(EXESUF): FF_EXTRALIBS += $(EXTRALIBS-$(1))
-include $$(OBJS-$(1):.o=.d)
endef
...
```

可以看出，ffmpeg的生成依赖于：

* **`fftools/ffmpeg_opt.c`**
* **`fftools/ffmpeg_filter.c`**
* **`fftools/ffmpeg_hw.c`**
* **`fftools/ffmpeg_qsv.c`**
* **`fftools/ffmpeg_videotoolbox.c`**

同时，在代码段`DOFFTOOL`中，还设置了通用的规则，使得每个工具都依赖于`工具名.o`文件和`cmdutils.o`文件。例如：ffmpeg依赖于ffmpeg.o，即ffmpeg.c文件。